<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    
    <title>DANE Study - Client-side Artifacts</title>
    <base href="https://dane-study.github.io">
    
    
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="./css/style.css">
    <link href="https://fonts.googleapis.com/css?family=Raleway:400,400i,700" rel="stylesheet">
    
    
    
    
    

    <noscript>
      <link rel="stylesheet" type="text/css" href="./css/noscript.css">
    </noscript>
  </head>
  <body class="container">
    <nav class="container-fluid navbar navbar-default">
  <div class="navbar-header">
    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse" aria-expanded="false">
    <span class="sr-only">Toggle navigation</span>
    <span class="icon-bar">&nbsp;</span>
    <span class="icon-bar">&nbsp;</span>
    <span class="icon-bar">&nbsp;</span>
    </button>
    <a class="navbar-brand" href="#">RPKI Study</a>
  </div>
  <div class="collapse navbar-collapse" id="navbar-collapse">
    <ul class="nav navbar-nav">
        <li><a href="/">Home</a></li>
        <li><a href="/server-side/">Server-side Artifacts</a></li>
        <li class="active"><a href="/client-side/">Client-side Artifacts</a></li>
        <li><a href="/contact/">Contact</a></li>
    </ul>
    <ul class="nav navbar-nav navbar-right">
    </ul>
  </div>
</nav>

    

    
    <noscript>
  <div class="alert alert-warning" role="alert">
    <strong>JavaScript disabled!</strong> This page requires JavaScript, you might not be able to access all content with JavaScript disabled.
  </div>
</noscript>

    <main class="container-fluid">
      

<h1 id="dane-for-smtp-client-side-artifacts-code">DANE for SMTP Client-side Artifacts Code</h1>

<style>
table, th { text-align: center;
}
</style>

<h2 id="preliminary">Preliminary</h2>

<ol>
<li><p>To analyze and determine a mail provider&rsquo;s policy, you first need to have a Bind9 and postfix running in your system. This is section consists of two parts: (1) Installation of DNS and SMTP softwares and (2) configuration of DNS and SMTP softwares to reproduce the results in USENIX&rsquo;20 paper.</p></li>

<li><p>First we need to install and configure the DNS server using bind9. We provide script which could be used to automatically create bind zone files.</p></li>

<li><p>Secondly, we need to install and configure SMTP server using postfix MTA. For reproducing the client side analysis results of USENIX&rsquo;20 paper, we heavily rely on Server Name Indication(SNI) to analyse multiple mail provider&rsquo;s policy.</p></li>

<li><p>Once you send an email from any of the mail service providers, you can utlise a script provided by us to analyse the policy of that provider.</p></li>
</ol>

<h2 id="summary-of-source-codes">Summary of source codes</h2>

<p>Here, we provide following source codes. The instruction and usage of the source codes are explainedbelow.</p>






<table class="table table-dark table-striped table-bordered">
<thead>
<tr>
<th>filename</th>
<th>Download</th>
<th>Misc.</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>configuration-bind-postfix.tar.gz</code></td>
<td><a href="/codes/configuration-bind-postfix.tar.gz">link</a></td>
<td>Bind and postfix configuration files.</td>
</tr>

<tr>
<td><code>generate-zone.py</code></td>
<td><a href="/codes/generate-zone.py">script</a> and <a href="/codes/security-protocol.com.yml">example Yaml</a></td>
<td>Generates bind zone file as per the yaml file .</td>
</tr>

<tr>
<td><code>install-postfix.sh</code></td>
<td><a href="/codes/install-postfix.sh">script</a></td>
<td>Installs SNI supported postfix. Note: Run the script as <code>root</code></td>
</tr>
</tbody>
</table>
<style>
table, th, td {
  text-align: center;
}
</style>


<h2 id="summary-of-existing-scenarios-build-to-determine-a-mail-provider-s-policy">Summary of existing scenarios build to determine a mail provider&rsquo;s policy</h2>






<table class="table table-dark table-striped table-bordered">
<thead>
<tr>
<th>Scenario</th>
<th>Description</th>
<th>misc</th>
</tr>
</thead>

<tbody>
<tr>
<td>valid.security-protocol.com</td>
<td>Serves proper TLSA and STARTTLS records</td>
<td></td>
</tr>

<tr>
<td>wrong-signature.security-protocol.com</td>
<td>Serves wrong RRSIG for TLSA record</td>
<td>Change the RRSIG hash for TLSA record</td>
</tr>

<tr>
<td>missing-signature.security-protocol.com</td>
<td>Serves no RRSIG for TLSA record</td>
<td>Delete the RRSIG hash for TLSA record</td>
</tr>

<tr>
<td>expired-starttls-tlsa-3.security-protocol.com</td>
<td>Serve expired certificate to create tlsa record with usage set to 3.</td>
<td></td>
</tr>

<tr>
<td>missing-ds.security-protocol.com</td>
<td>Serve no DS record for the domain in the chain</td>
<td></td>
</tr>

<tr>
<td>self-signed-starttls.security-protocol.com</td>
<td>Serve self signed leaf certificate for the domain during STARTTLS validation</td>
<td></td>
</tr>

<tr>
<td>cn-diff-starttls.security-protocol.com</td>
<td>Serve a leaf certificate where the Common Name (CN) field is different.</td>
<td></td>
</tr>

<tr>
<td>different-cert.security-protocol.com</td>
<td>Serve different certificates for creating a TLSA record and in the SNI chain for STARTTLS validation</td>
<td></td>
</tr>

<tr>
<td>dane-diff-match.security-protocol.com</td>
<td>Serve a self-signed leaf certificate and create a valid TLSA record and just change the matching type field manually</td>
<td></td>
</tr>

<tr>
<td>dane-diff-selector.security-protocol.com</td>
<td>Create a TLSA record with selector 1 and then modify the TLSA record with any busted value</td>
<td></td>
</tr>

<tr>
<td>dane-diff-usage-1.security-protocol.com</td>
<td>Serves a self-signed leaf certificate and create a valid TLSA record with usage 1 (PKIX-EE) and then modify the TLSA record with “busted certificate association data”</td>
<td></td>
</tr>

<tr>
<td>dane-diff-usage-3.security-protocol.com</td>
<td>Serve a CA signed leaf certificate in the chain.</td>
<td>Domain issued certificate (and DANE-EE) which indicates a self-signed certificate to create TLSA record.</td>
</tr>
</tbody>
</table>
<style>
table, th, td {
  text-align: center;
}
</style>


<h1 id="reproducing-the-client-configuration-in-the-usenix-security-20-paper">Reproducing the client configuration in the USENIX Security&rsquo;20 paper</h1>

<h2 id="1-setting-up-bind-dns-server">1. Setting up Bind DNS server</h2>

<p>To validate the client side results presented in USENIX Security&rsquo;20 paper, you need to have a DNSSEC supported DNS server. But below explain how we used  Bind software as DNS server.</p>

<h3 id="install-bind9-dns-server">Install Bind9 DNS server</h3>

<p>Assuming that you are using a Linux flavoured operating system. You need to install ‘bind9 bind9utils bind9-doc dnsutils’ to install BIND 9 &amp; related tools.</p>

<pre><code>$ sudo apt-get install bind9 bind9utils bind9-doc dnsutils
</code></pre>

<h3 id="configure-bind9">Configure Bind9</h3>

<p>One of the important configuration file for bind is <code>“/etc/bind/named.conf.options“</code>, from this file we can set the followings parameters:</p>

<ul>
<li>Allow Query to your dns from your private network (As the name suggests only the systems from your private network can query dns sever for name to ip translation and vice-versa)</li>
<li>Allow recursive query</li>
<li>Specify the DNS port ( 53)</li>

<li><p>Forwarders (DNS query will be forwarded to the forwarders when your local DNS server is unable to resolve query)</p>

<pre><code>options {
    directory &quot;/var/cache/bind&quot;;

    recursion yes;
    allow-recursion { trusted; };
    allow-transfer { none; };

    forwarders {
            8.8.8.8;
            8.8.4.4;
    };

		dnssec-validation auto;
    dnssec-enable yes;

    auth-nxdomain no;    # conform to RFC1035
    listen-on-v6 { any; };

};

</code></pre></li>
</ul>

<p>To support logging facility in Bind9 DNS server</p>

<pre><code>logging {
        channel named       { file &quot;named.log&quot; versions 10 size 20M; print-time yes; print-category yes; };
        channel security    { file &quot;security.log&quot; versions 10 size 20M; print-time yes; };
        channel query_log   { file &quot;query.log&quot; versions 10 size 20M; severity debug; print-time yes; };
        channel query_error { file &quot;query-errors.log&quot; versions 10 size 20M; severity info; print-time yes; };
        channel transfer    { file &quot;transfer.log&quot; versions 10 size 10M; print-time yes; };
        channel dnssec_log  { file &quot;dnssec.log&quot;; severity debug 3; };

        category dnssec     { dnssec_log; };
        category default    { default_syslog; named; };
        category general    { default_syslog; named; };
        category security   { security; };
        category queries    { query_log; };
        category config     { named; };
        category xfer-in    { transfer; };
        category xfer-out   { transfer; };
        category notify     { transfer; };
};
</code></pre>

<h4 id="create-forward-zone-file">Create Forward Zone File</h4>

<p>You can use the <code>generate-zone.py</code> script to generated a zone file automatically. Add the record type you need to represent in a zone in a YAML file as available in the <a href="/codes/security-protocol.com.yml">example Yaml</a>.</p>

<p><code>Note: Do not forget to update the serial value by 1 for every change you make on to the zone.</code></p>

<p>Example zone file:</p>

<pre><code>;
; BIND data file for local loopback interface
;
$TTL    1
@       IN      SOA     ns01.valid.security-protocol.com. admin.valid.security-protocol.com. (
                             27         ; Serial
                         604800         ; Refresh
                          86400         ; Retry
                        2419200         ; Expire
                         604800 )       ; Negative Cache TTL
;
; name servers - NS records
        IN      NS      ns01.security-protocol.com.
        IN      NS      ns02.security-protocol.com.

; name servers - A records
ns01.valid.security-protocol.com.      IN      A       34.219.137.44
ns02.valid.security-protocol.com.      IN      A       34.219.137.44

; A record
valid.security-protocol.com.   IN      A       34.219.137.44

; MX record

mail.valid.security-protocol.com.      IN      A       34.219.137.44
@       IN      MX      10 mail.valid.security-protocol.com.

</code></pre>

<p>We need to sign the zones created to support DNSSEC for each domains.</p>

<p>Navigate to some location where you would like to store the keys. For example, we choose to store it in <code>/etc/bind/keys/&lt;domainname.com&gt;</code></p>

<pre><code> $ sudo dnssec-keygen -a RSASHA256 -b 2048 -3 -f KSK -r /dev/urandom security-protocol.com
 $ sudo dnssec-keygen -a RSASHA256 -b 2048 -3 -r /dev/urandom security-protocol.com
</code></pre>

<p>The above command helps you to generate KSK and ZSK keys. The directory will now have 4 keys - private/public pairs of ZSK and KSK. We have to add the public keys which contain the DNSKEY record to the zone file.</p>

<p>Once the DNSSEC signing keys are generated, you need to sign the zones.</p>

<p>Sign the zone with the <code>dnssec-signzone</code> command.</p>

<pre><code>$ dnssec-signzone -3 &lt;salt&gt; -A -N INCREMENT -o &lt;zonename&gt; -t &lt;zonefilename&gt;
</code></pre>

<p>Example:</p>

<pre><code>$ sudo dnssec-signzone -S -K /etc/bind/keys/security-protocol -e 20250530144500 -g -a -r /dev/random -o security-protocol.com zones/db.security-protocol.com 
</code></pre>

<p>Next configuration file is <code>“/etc/bind/named.conf.local“</code>, in this file we will define the zone files for our domain, edit the file add the following entries:</p>

<p><code>Note: If your domain is DNSSEC-enabled, then you need to point the signed zone in “/etc/bind/named.conf.local“</code></p>

<pre><code>zone &quot;security-protocol.com&quot; {
        type master;
        file &quot;/etc/bind/zones/db.security-protocol.com.signed&quot;;
};

zone &quot;security-protocol.com&quot; {
        type master;
        file &quot;/etc/bind/zones/db.security-protocol.com.signed&quot;;
};

zone &quot;expired-starttls-tlsa-3.security-protocol.com&quot; {
        type master;
        file &quot;/etc/bind/zones/db.expired-starttls-tlsa-3.security-protocol.com.signed&quot;;
};

zone &quot;expired-starttls-no-tlsa.security-protocol.com&quot; {
        type master;
        file &quot;/etc/bind/zones/db.expired-starttls-no-tlsa.security-protocol.com&quot;;
};

zone &quot;different-cert.security-protocol.com&quot; {
        type master;
        file &quot;/etc/bind/zones/db.different-cert.security-protocol.com.signed&quot;;
};

...

</code></pre>

<p>Save file &amp; exit. Now all we have to do is to restart the BIND service to implement the changes made,</p>

<pre><code>$ sudo service bind9 restart
$ sudo service bind9 enable 
</code></pre>

<p><code>Note:</code> In case OS firewall is running on your bind server then execute the below command to allow 53 port</p>

<pre><code>$ sudo ufw allow 53
</code></pre>

<h2 id="2-setting-up-postfix-smtp-server">2. Setting up postfix SMTP server</h2>

<p>Below, we provide detailed instructions on how to install postfix MTA. We specifically suggest to use postfix 3.4.5 or above because we needed SNI to support serving multiple certificates, which we will explain in detail later.</p>

<h3 id="install-postfix-mta">Install Postfix MTA</h3>

<p>You can either use the <code>install-postfix.sh</code> script to automatically install postfix or either if the script fails or would like to manually install postfix, please follow the below instruction.</p>

<p>Assuming that you are using a Linux flavoured operating system.</p>

<p>Download the latest version of postfix 3.4.8 from here:</p>

<pre><code>ftp://ftp.porcupine.org/mirrors/postfix-release/official/postfix-3.4.8.tar.gz
</code></pre>

<p>You also need to download and apply this specific patch as well.</p>

<pre><code>http://www.linuxfromscratch.org/patches/blfs/svn/postfix-3.4.8-glibc230_fix-1.patch
</code></pre>

<p>Postfix recommended Dependencies that you should have:</p>

<pre><code>Berkeley DB-5.3.28
Cyrus SASL-2.1.27
libnsl-1.2.0
</code></pre>

<p>Once you have all the required dependencies for postfix, you can proceed to the installation process as follows:</p>

<h4 id="start-by-adding-users-and-groups">Start by Adding users and groups</h4>

<p>Before you compile the program, you need to create users and groups that will be expected to be in place during the installation. Add the users and groups with the following commands issued by the root user:</p>

<pre><code>groupadd -g 32 postfix &amp;&amp;
groupadd -g 33 postdrop &amp;&amp;
useradd -c &quot;Postfix Daemon User&quot; -d /var/spool/postfix -g postfix \
        -s /bin/false -u 32 postfix &amp;&amp;
chown -v postfix:postfix /var/mail
</code></pre>

<h4 id="configuring-the-build">Configuring the Build</h4>

<p>The README files are formatted to be read with a pager like Less or More. If you want to use a text editor, make them legible with the following sed:</p>

<pre><code>sed -i 's/.\x08//g' README_FILES/*
</code></pre>

<p>Apply a patch to allow Postfix to compile on Glibc-2.30 where some macros were dropped:</p>

<pre><code>patch -Np1 -i ../postfix-3.4.8-glibc230_fix-1.patch
</code></pre>

<p><strong>Cyrus-SASL</strong></p>

<p>To use Cyrus-SASL with Postfix, use the following arguments:</p>

<pre><code>CCARGS='-DUSE_SASL_AUTH -DUSE_CYRUS_SASL -I/usr/include/sasl'
AUXLIBS='-lsasl2'
</code></pre>

<p><br/></p>

<h4 id="database-configuration-for-postfix">Database configuration for postfix</h4>

<p>You can utilse any of the database software such as sqlite, mysql or postgreSQL as below.
<br/></p>

<p><strong>Sqlite:</strong></p>

<p>To use Sqlite with Postfix, use the following arguments:</p>

<pre><code>CCARGS='-DHAS_SQLITE'
AUXLIBS='-lsqlite3 -lpthread'
</code></pre>

<p><strong>MySQL:</strong></p>

<p>To use MySQL with Postfix, use the following arguments:</p>

<pre><code>CCARGS='-DHAS_MYSQL -I/usr/include/mysql'
AUXLIBS='-lmysqlclient -lz -lm'
</code></pre>

<p><strong>PostgreSQL:</strong></p>

<p>To use PostgreSQL with Postfix, use the following arguments:</p>

<pre><code>CCARGS='-DHAS_PGSQL -I/usr/include/postgresql'
AUXLIBS='-lpq -lz -lm'
</code></pre>

<h4 id="starttls-authentication">STARTTLS Authentication</h4>

<p>To use OpenSSL with Postfix, use the following arguments:</p>

<pre><code>CCARGS='-DUSE_TLS -I/usr/include/openssl/'
AUXLIBS='-lssl -lcrypto'
</code></pre>

<p><br/></p>

<h4 id="installing-postfix">Installing Postfix</h4>

<p>If you have Cyrus SASL and OpenSSL installed, install Postfix by running the following commands:</p>

<pre><code>make CCARGS=&quot;-DUSE_TLS -I/usr/include/openssl/                     \
             -DUSE_SASL_AUTH -DUSE_CYRUS_SASL -I/usr/include/sasl&quot; \
     AUXLIBS=&quot;-lssl -lcrypto -lsasl2&quot;                              \
     makefiles &amp;&amp;
make
</code></pre>

<p>Now, as the root user:</p>

<pre><code>sh postfix-install -non-interactive \
   daemon_directory=/usr/lib/postfix \
   manpage_directory=/usr/share/man \
   html_directory=/usr/share/doc/postfix-3.4.8/html \
   readme_directory=/usr/share/doc/postfix-3.4.8/readme
</code></pre>

<h3 id="3-configure-postfix">3. Configure postfix</h3>

<p>In this section, you will configure the /etc/postfix/main.cf file to use the external SMTP server.</p>

<p>Open the /etc/postfix/main.cf file with your favorite text editor:</p>

<pre><code>sudo vim /etc/postfix/main.cf
</code></pre>

<p>Add the following parameters to the config file as to enable TLS service for your SMTP server.</p>

<pre><code>smtpd_use_tls = yes
smtpd_tls_loglevel = 2
</code></pre>

<p>If you are missing any additional parameters in the postfix setup, do checkout our example configuration files found <a href="/codes/configuration-bind-postfix.tar.gz">here</a></p>

<h4 id="sni-configuration">SNI configuration</h4>

<p>Unlike the usual setup to serve a single TLS certificate file and a TLS key file in the postfix SMTP MTA configuration as to initiate STARTTLS security extension support, we wanted to serve multiple certificates within the same domain as well as within the delegated domains. The configuration file specifies a very small subset of all the parameters that control the operation of the Postfix mail system.</p>

<p>Run through the initial configuration after the installation of postfix from the apt package and then, upgrade postfix through the installation from source. Further, when that is done, we move on to configure SNI. We use SNI here in order to serve multiple certificates to the TLS chain on each delegated domains.</p>

<p>For the SNI setup, we created a few certificate chains which were wildcard certificates for the third-level domains. This was followed by creating a hash table using <code>sudo postmap -F</code> to hold the SNI chains where the domains are denoted as:</p>

<pre><code>domain1.com static:/path/to/pem1.pem 
domain2.com static:/path/to/pem2.pem
</code></pre>

<p>Which then is referred in the <code>/etc/postfix/main.cf</code> configuration of postfix using:</p>

<p><code>tls_server_sni_maps = hash:/etc/postfix/sni-chains</code></p>

<p>In <code>/etc/postfix/main.cf</code> <strong>Before</strong>:</p>

<pre><code>smtpd_tls_key_file = /path/to/the/key/file/smtp_tls.key
smtpd_tls_cert_file = /path/to/the/cert/file/smtp_cert.pem
</code></pre>

<p>With this configuration parameter alone, we are only able to provide/serve single key and certificate file for the SMTP server for a specific single domain.</p>

<p><strong>Now:</strong></p>

<p>Our goal was to serve multiple certificates for each of the delegated domains as per the busted environment that we devised.</p>

<p>First, we provide a parameter <code>smtpd_tls_chain_files</code> to the configuration file as to provide a default certificate to the SNI lookup table that is going to be created. The SNI lookup tables should also have entries for the domains that correspond to the Postfix SMTP server&rsquo;s default certificate(s). This ensures that the remote SMTP client&rsquo;s TLS SNI extension gets a positive response when it specifies one of the Postfix SMTP server&rsquo;s default  domains, and ensures that the Postfix SMTP server will not log an SNI name mismatch for such a domain. The Postfix SMTP server&rsquo;s default certificates are then only used when the client sends no SNI or when it sends SNI with a domain that the server knows no certificate(s) for.</p>

<pre><code>smtpd_tls_chain_files = /etc/letsencrypt/live/security-protocol.com/privkey.pem, /etc/letsencrypt/live/security-protocol.com/cert.pem
</code></pre>

<p>Yes, having a default as such might be inconvenient for few use cases. Currently, postfix has this in place since default chain with an explicitly SNI mapping to that chain, is to suppress warnings in the logs about receiving SNI names that fail to match any entries in the table. Such warnings can be useful to identify misconfigured clients and servers. Setting up a wildcard default would completely defeat the purpose of the mismatch logging.</p>

<p>That is, smtpd_tls_chain_files parameter assures the client with a positive acknowledgement, and suppresses logging of SNI mismatch. Suppressing such logs for $myhostname since default chain is the right one to use.</p>

<p>Further we denote the SNI table created inside the configuration file through the parameter <code>tls_server_sni_maps</code></p>

<pre><code>main.cf:
       tls_server_sni_maps = hash:/etc/postfix/sni-chains
</code></pre>

<pre><code>sni-chains: 
       mail.security-protocol.com	/etc/postfix/sni/domain1.example.pem 
       mail.domain2.security-protocol.com	/etc/postfix/sni/domain2.example.pem
</code></pre>

<p>The sni-chains is a SNI lookup table created for storing certificate chains mapped to the SNI domains. In postfix, we use a postmap command to create the hash table. The syntax is:</p>

<p><code>$ postmap -F hash:/etc/postfix/sni-chains</code></p>

<p>Need to note that, You&rsquo;ll need to rebuild the table (again with &ldquo;postmap -F&rdquo;) whenever you want to start using new certificates, adding new certificates  even if the file names are unchanged.</p>

<p>Further also note that, The sni-chain must always list the private key before the associated certificate chain. You can list a file with just the key first, and then the certificate file. An advanced use case is to list multiple files for the same domain, each with a key and certificate chain for a different algorithm.</p>

<p>Example sni-chain file:</p>

<pre><code>mail.security-protocol.com /etc/letsencrypt/live/security-protocol.com/privkey.pem /etc/letsencrypt/live/security-protocol.com/fullchain.pem
mail.valid.security-protocol.com /etc/letsencrypt/live/valid.security-protocol.com/privkey.pem /etc/letsencrypt/live/valid.security-protocol.com/fullchain.pem
mail.different-cert.security-protocol.com /etc/letsencrypt/live/security-protocol.com/privkey.pem /etc/letsencrypt/live/security-protocol.com/fullchain.pem
</code></pre>

<p>Save your changes.</p>

<p>Restart Postfix:</p>

<pre><code>sudo service postfix restart
</code></pre>

    </main>
    <footer class="container-fluid page-footer" style="display: flex; align-items: center">
</footer>

    
<script type="text/javascript">
var sc_project=11603023; 
var sc_invisible=1; 
var sc_security="a906280a"; 
var scJsHost = (("https:" == document.location.protocol) ?
"https://secure." : "http://www.");
document.write("<sc"+"ript type='text/javascript' src='" +
scJsHost+
"statcounter.com/counter/counter.js'></"+"script>");
</script>
<noscript><div class="statcounter"><a title="Web Analytics"
href="http://statcounter.com/" target="_blank"><img
class="statcounter"
src="//c.statcounter.com/11603023/0/a906280a/1/" alt="Web
Analytics"></a></div></noscript>


    
    <script src="js/jquery.1.12.4.min.js"></script>
    
    <script src="js/bootstrap.min.js"></script>
    <script src="js/script.js"></script>
  </body>
</html>
